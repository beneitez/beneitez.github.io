const mstdRoot=getElement("mastodon-comments"),tootUri=mstdRoot.dataset.uri,respondToVisibility=(e,t)=>{const n=new IntersectionObserver(e=>{e.forEach(e=>{e.intersectionRatio>0&&t()})},{root:null});n.observe(e)},i18nreplies=getElement("i18n--is-replies").innerHTML,i18nreblogs=getElement("i18n--is-reblogs").innerHTML,i18nfavourites=getElement("i18n--is-favourites").innerHTML,i18nLoading=getElement("i18n--is-loading").innerHTML,i18nErr=getElement("i18n--is-error").innerHTML,i18nNoComment=getElement("i18n--no-comment").innerHTML,style=document.createElement("style");if(style.textContent=`
    #comments > * {width: var(--golden-ratio)}
    #comments noscript {margin: var(--medskip) 0}
    #discussion-starter {margin-bottom: var(--medskip)}
    #discussion-starter > footer {display: flex; align-items: center; justify-content: space-between; margin-top: 1em}
    .fediverse-comment {margin: 1rem 0 1rem calc(var(--mul) * var(--indent)); border: 1pt solid #fff4; border-left: 2pt solid var(--ac); background: #80808008; padding: 1rem 1rem 1ex; box-shadow: 0 0.5pt 1pt 0 var(--g18s); overflow: auto}
    .fediverse-comment.bsky {--ac: #1185fe}
    .fediverse-comment.mstd {--ac: #563acc}
    .fediverse-comment > .author > img{margin-right: 12pt}
    .fediverse-comment .content {margin-left: 4rem; line-height: calc(var(--baselineStretch) * 1.272)}
    .fediverse-comment .par a {max-width: 100%; vertical-align: bottom; white-space: break-spaces}
    .fediverse-comment > footer {display: flex; align-items: center; margin-top: 1rem; margin-left: 3.5rem; white-space: nowrap}
    .fediverse-comment > footer .stat {display: inline-flex; flex-shrink: 0; gap: 5pt}
    .attachments {display: flex;overflow: auto}
    .attachments > * {flex-shrink: 0; width: 100%; height: auto}
    .attachments img {width: 100%; height: auto}
    .stat > * {display: inline-flex; align-items: center; padding: 2pt; color: var(--mid); gap: 2pt;}
    .stat > *::before {vertical-align: text-top; font-family: 'base-ui';}
    .stat > * > span {font-size: 0.8em}
    a.replies.active, a.reblogs.active {color: var(--ac)}
    a.favourites.active {color: var(--i3i)}
    .fediverse-comment .date {margin-left: auto; padding-left: 1rem; color: var(--mid); font-size: calc(10pt * var(--fontScale))}
    @media only screen and (max-width: 960px) {
        .fediverse-comment .content, .fediverse-comment > footer {margin-left: 0}
    }`,document.head.appendChild(style),tootUri){function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}let n=!1;const e=(e,t)=>{const n=e[`${t}_count`];return n>0?"active":""},t=(e,t)=>{const n=e[`${t}_count`];return n>0?n:""},s=n=>`
        <a class="replies ${e(n,"replies")}" href="${n.url}" rel="nofollow" aria-label="${i18nreplies}">
            <span>${t(n,"replies")}</span>
        </a>
        <a class="reblogs ${e(n,"reblogs")}" href="${n.url}" rel="nofollow" aria-label="${i18nreblogs}">
            <span>${t(n,"reblogs")}</span>
        </a>
        <a class="favourites ${e(n,"favourites")}" href="${n.url}" rel="nofollow" aria-label="${i18nfavourites}">
            <span>${t(n,"favourites")}</span>
        </a>`,r=e=>{const t={image:()=>`<a href="${e.url}" rel="nofollow"><img src="${e.preview_url}" alt="${e.description}" loading="lazy" /></a>`,video:()=>`<video controls><source src="${e.url}" type="${e.mime_type}"></video>`,gifv:()=>`<video autoplay loop muted playsinline><source src="${e.url}" type="${e.mime_type}"></video>`,audio:()=>`<audio controls><source src="${e.url}" type="${e.mime_type}"></audio>`,default:()=>`<a href="${e.url}" rel="nofollow">${e.type}</a>`};return(t[e.type]||t.default)()},o=e=>`
        <div class="par" data-bionRead-safe>${e.content}</div>
        <div class="attachments">${e.media_attachments.map(r).join("")}</div>
    `,i=e=>{let t=`@${e.acct}`;if(!e.acct.includes("@")){const n=new URL(e.url);t+=`@${n.hostname}`}return t},a=(e,t,n)=>{const s=e.filter(e=>e.in_reply_to_id===t).sort((e,t)=>e.created_at.localeCompare(t.created_at));s.forEach(t=>c(e,t,n))},c=(e,t,n)=>{t.account.display_name=escapeHtml(t.account.display_name),t.account.emojis.forEach(e=>{t.account.display_name=t.account.display_name.replace(`:${e.shortcode}:`,`<img src="${escapeHtml(e.static_url)}" alt="Emoji ${e.shortcode}" height="20" width="20" />`)});const r=`
        <li>
            <article class="fediverse-comment mstd" style="--mul: ${n}">
                <header class="author">
                    <img src="${escapeHtml(t.account.avatar_static)}" height=48 width=48 alt="${i(t.account)}" loading="lazy"/>
                    <a class="has-aria-label" href="${t.account.url}" rel="nofollow" title="${t.account.display_name}" aria-label="${i(t.account)}">
                        <span>${t.account.display_name}</span>
                    </a>
                </header>
                <div class="content">${o(t)}</div>
                <footer>
                    <div class="stat">${s(t)}</div>
                    <a class="date" href="${t.url}" rel="nofollow">
                        <time datetime="${toISOString(t.created_at)}">${formatDate(t.created_at)}</time>
                    </a>
                </footer>
            </article>
        </li>`;mstdRoot.appendChild(DOMPurify.sanitize(r,{RETURN_DOM_FRAGMENT:!0})),a(e,t.id,n+1)},l=async()=>{if(n)return;mstdRoot.innerHTML=i18nLoading;const e=tootUri.split("/");function t(){if(e[0]==="https:"||e[0]==="http:")return"https://"+e[2]+"/api/v1/statuses/"+e[4]}try{const[c,l]=await Promise.all([fetch(t()),fetch(t()+`/context`)]),[i,r]=await Promise.all([c.json(),l.json()]);getElement("mastodon-content").innerHTML=o(i),getElement("mastodon-stats").innerHTML=s(i),r.descendants?.length>0?(mstdRoot.innerHTML="",a(r.descendants,e[4],0)):mstdRoot.innerHTML=i18nNoComment,n=!0,mstdRoot.setAttribute("aria-busy","false")}catch(e){console.error(`Mastodon ${i18nErr}`,e),mstdRoot.innerHTML=`Mastodon ${i18nErr} : ${e}`}};respondToVisibility(mstdRoot,l)}const bskyRoot=document.querySelector("#bsky-comments");function ToBskyUrl(e){const t=e.split("/");return t[0]==="at:"?"https://bsky.app/profile/"+t[2]+"/post/"+t[4]:e}function ToAtProtoUri(e){const t=e.split("/");return t[0]==="https:"||t[0]==="http:"?"at://"+t[4]+"/app.bsky.feed.post/"+t[6]:e}function ToBskyImgUrl(e,t,n){return`https://cdn.bsky.app/img/${n?"feed_thumbnail":"feed_fullsize"}/plain/${e}/${t}`}const atProto=ToAtProtoUri(bskyRoot.dataset.uri);if(atProto){const e=async()=>{try{const e=await fetch("https://public.api.bsky.app/xrpc/app.bsky.feed.getPostThread?uri="+atProto);if(!e.ok)throw new Error(`HTTP error, status = ${e.status}`);const t=await e.json();typeof t.thread.replies!="undefined"&&t.thread.replies.length>0?(bskyRoot.appendChild(DOMPurify.sanitize(renderComments(t.thread),{RETURN_DOM_FRAGMENT:!0})),bskyRoot.setAttribute("aria-busy","false")):bskyRoot.innerHTML=i18nNoComment}catch(e){console.error(`Bluesky ${i18nErr}`,e),bskyRoot.innerHTML=`Bluesky ${i18nErr} : ${e}`}};function renderComments(e){const t=document.createDocumentFragment();for(const n of e.replies){const o=renderComment(n),s=createElementFromHTML(o);s.querySelector(".hasReplies").appendChild(renderComments(n)),t.appendChild(s)}return t}function createElementFromHTML(e){const t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}function renderRichText(e){let o=`<p>`;const a=new TextEncoder,i=new TextDecoder,t=new Uint8Array(e.text.length*3);a.encodeInto(e.text,t);var s,n=0;for(const l in e.facets){const a=e.facets[l],r=a.features[0],c=r.$type;if(s="#",c=="app.bsky.richtext.facet#tag"?s=`https://bsky.app/hashtag/${r.tag}`:c=="app.bsky.richtext.facet#link"?s=r.uri:c=="app.bsky.richtext.facet#mention"&&(s=`https://bsky.app/profile/${r.did}`),n<a.index.byteStart){const e=t.slice(n,a.index.byteStart);o+=i.decode(e)}const d=t.slice(a.index.byteStart,a.index.byteEnd);o+=`<a href="${s}" target="_blank">`+i.decode(d)+"</a>",n=a.index.byteEnd}if(n<t.length){const e=t.slice(n,t.length);o+=i.decode(e)}return o+"</p>"}function renderAttachment(e){let t="";const n=e.author.did;if(e.embed){const s=e.embed.$type;if(s==="app.bsky.embed.external#view"){const{uri:n,title:s,description:o}=e.embed.external;n.includes(".gif?")&&(t=`<img src="${n}" title="${s}" alt="${o}">`)}else if(s==="app.bsky.embed.images#view"){const s=e.record.embed.images;t=s.map(e=>{const t=ToBskyImgUrl(n,e.image.ref.$link,!0),s=ToBskyImgUrl(n,e.image.ref.$link,!1);return`<a href="${s}" target="_blank"><img src="${t}" alt="${e.alt}"></a>`}).join("")}else if(s==="app.bsky.embed.video#view"){const s=e.record.embed.video;t=`<video controls poster="${e.embed.thumbnail}">
                    <source src="https://bsky.social/xrpc/com.atproto.sync.getBlob?cid=${s.ref.$link}&did=${n}" type="${s.mimeType}"></video>`}}return t}function renderComment(e){const t=new Date(e.post.record.createdAt);return`
        <li>
            <article class="fediverse-comment bsky" style="margin-bottom: 1rem">
            <header class="author">
                <img src="${e.post.author.avatar}" width=58 height=48 alt="${e.post.author.handle}" loading="lazy" />
                <a class="has-aria-label" href="https://bsky.app/profile/${e.post.author.handle}" rel="ugc" aria-label="@${e.post.author.handle}">
                    <span>${e.post.author.displayName}</span>
                </a>
            </header>
            <div class="content">
                <div class="par">${renderRichText(e.post.record)}</div>
                <div class="attachments">${renderAttachment(e.post)}</div>
            </div>
            <footer>
                <div class="stat">
                <a class="replies ${e.post.replyCount>0?"active":""}" href="${ToBskyUrl(e.post.uri)}" rel="nofollow"  aria-label="${i18nreplies}">
                    <span>${e.post.replyCount>0?e.post.replyCount:""}</span>
                </a>
                <a class="reblogs ${e.post.repostCount>0?"active":""}" href="${ToBskyUrl(e.post.uri)}" rel="nofollow" aria-label="${i18nreblogs}">
                    <span>${e.post.repostCount>0?e.post.repostCount:""}</span>
                </a>
                <a class="favourites ${e.post.likeCount>0?"active":""}" href="${ToBskyUrl(e.post.uri)}" rel="nofollow" aria-label="${i18nfavourites}">
                    <span>${e.post.likeCount>0?e.post.likeCount:""}</span>
                </a>
                </div>
                <a class="date" href="${ToBskyUrl(e.post.uri)}" rel="nofollow"><time datetime="${t.toISOString}">${formatDate(t)}</time></a>
            </footer>
            </article>
            <ul class="hasReplies" style="margin-left: var(--indent); padding: 0; list-style: none"></ul>
        </li>`}respondToVisibility(bskyRoot,e())}